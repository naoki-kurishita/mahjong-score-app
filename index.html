<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éº»é›€ã‚¹ã‚³ã‚¢">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <title>ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢è¨ˆç®—æ©Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.2);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: white;
            border: none;
            font-size: 1em;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-tab.active {
            color: var(--primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .nav-tab:active {
            background: var(--bg-light);
        }

        /* Content Sections */
        .content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Game Setup Section */
        .game-setup {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .player-inputs {
            display: grid;
            gap: 15px;
        }

        .player-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-number {
            width: 35px;
            height: 35px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .input-field {
            flex: 1;
            padding: 12px 15px;
            font-size: 1em;
            border: 2px solid var(--border);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Button Styles */
        .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Score Input Section */
        .round-info {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .round-number {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
        }

        .score-inputs {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .score-input-row {
            display: flex;
            align-items: center;
            background: var(--bg-light);
            padding: 15px;
            border-radius: 12px;
            gap: 15px;
        }

        .player-name-display {
            flex: 1;
            font-weight: 600;
            font-size: 1.1em;
        }

        .score-input {
            width: 140px;
            padding: 12px;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
        }

        .score-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .validation-error {
            background: #fee;
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95em;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        /* Scoreboard */
        .scoreboard {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .scoreboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 700;
            text-align: center;
        }

        .scoreboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .scoreboard-table th {
            background: var(--bg-light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-light);
        }

        .scoreboard-table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border);
        }

        .scoreboard-table tr:last-child td {
            border-bottom: none;
        }

        .rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.1em;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #333; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #333; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e09856 100%); }
        .rank-4 { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }

        .player-name-cell {
            font-weight: 600;
            font-size: 1.1em;
        }

        .score-cell {
            font-weight: 700;
            font-size: 1.2em;
        }

        .score-positive {
            color: var(--success);
        }

        .score-negative {
            color: var(--danger);
        }

        /* History Section */
        .history-list {
            display: grid;
            gap: 15px;
        }

        .history-item {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .history-round {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .history-scores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .history-score-item {
            font-size: 0.95em;
        }

        /* Settings Section */
        .settings-group {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .settings-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .settings-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1em;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.3s;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .score-input {
                width: 110px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢è¨ˆç®—æ©Ÿ</h1>
            <div class="subtitle">ç°¡å˜ãƒ»æ­£ç¢ºãƒ»è‡ªå‹•è¨ˆç®—</div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('room')">ãƒ«ãƒ¼ãƒ </button>
            <button class="nav-tab" onclick="switchTab('setup')">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</button>
            <button class="nav-tab" onclick="switchTab('game')" id="gameTab">ã‚²ãƒ¼ãƒ </button>
            <button class="nav-tab" onclick="switchTab('scoreboard')">ã‚¹ã‚³ã‚¢</button>
            <button class="nav-tab" onclick="switchTab('history')">å±¥æ­´</button>
        </div>

        <!-- Room Selection Section -->
        <div id="roomContent" class="content active">
            <div class="section-title">ğŸ”— ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ </div>
            
            <div id="roomSelection" style="display: block;">
                <div style="background: #dbeafe; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 1em; color: #1e40af; font-weight: 600; margin-bottom: 8px;">
                        ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸæ©Ÿèƒ½
                    </div>
                    <div style="font-size: 0.9em; color: #64748b; line-height: 1.6;">
                        4äººãŒåŒã˜ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ã¨ã€èª°ã‹ãŒç‚¹æ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨å…¨å“¡ã®ç”»é¢ã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™
                    </div>
                </div>

                <button class="btn btn-primary" onclick="createRoom()" style="margin-bottom: 15px;">
                    <span>â•</span>
                    <span>æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œæˆ</span>
                </button>

                <div style="text-align: center; margin: 20px 0; color: #94a3b8; font-size: 0.9em;">
                    ã¾ãŸã¯
                </div>

                <div class="settings-group">
                    <label class="settings-label">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</label>
                    <input type="text" class="settings-input" id="roomCodeInput" placeholder="ä¾‹: A7B3" maxlength="4" style="text-transform: uppercase; text-align: center; font-size: 1.3em; font-weight: 700; letter-spacing: 0.1em;">
                </div>

                <button class="btn btn-success" onclick="joinRoom()">
                    <span>ğŸšª</span>
                    <span>ãƒ«ãƒ¼ãƒ ã«å‚åŠ </span>
                </button>

                <div style="margin-top: 30px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 0.85em; color: #92400e;">
                        ğŸ’¡ <strong>ãƒ’ãƒ³ãƒˆ:</strong> ãƒ›ã‚¹ãƒˆãŒä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ä»–ã®3äººã«ä¼ãˆã¦å‚åŠ ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†
                    </div>
                </div>
            </div>

            <div id="roomInfo" style="display: none;">
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 0.9em; margin-bottom: 8px;">æ¥ç¶šä¸­ã®ãƒ«ãƒ¼ãƒ </div>
                    <div style="font-size: 2.5em; font-weight: 700; letter-spacing: 0.15em; margin-bottom: 8px;" id="currentRoomCode"></div>
                    <div style="font-size: 0.85em; opacity: 0.9;">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å…±æœ‰</div>
                </div>

                <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #475569;">å‚åŠ è€…ï¼ˆ<span id="participantCount">0</span>/4ï¼‰</div>
                    <div id="participantList"></div>
                </div>

                <button class="btn btn-primary" onclick="startGameFromRoom()">
                    <span>ğŸ®</span>
                    <span>ã‚²ãƒ¼ãƒ é–‹å§‹</span>
                </button>

                <button class="btn btn-danger" onclick="leaveRoom()" style="margin-top: 10px;">
                    ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡º
                </button>
            </div>
        </div>

        <!-- Setup Section -->
        <div id="setupContent" class="content active">
            <div class="game-setup">
                <div class="section-title">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›</div>
                <div class="player-inputs">
                    <div class="player-input-group">
                        <div class="player-number">1</div>
                        <input type="text" class="input-field" id="player1" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" value="ã‚µãƒˆã‚¦">
                    </div>
                    <div class="player-input-group">
                        <div class="player-number">2</div>
                        <input type="text" class="input-field" id="player2" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2" value="ãƒŸãƒ¤ã‚ª">
                    </div>
                    <div class="player-input-group">
                        <div class="player-number">3</div>
                        <input type="text" class="input-field" id="player3" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3" value="ã‚¦ã‚·ã‚¸ãƒ">
                    </div>
                    <div class="player-input-group">
                        <div class="player-number">4</div>
                        <input type="text" class="input-field" id="player4" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4" value="ã‚¯ãƒªã‚·ã‚¿">
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <label class="settings-label">åˆæœŸæŒã¡ç‚¹ï¼ˆå®Ÿéš›ã®ç‚¹æ•°ï¼‰</label>
                <input type="number" class="settings-input" id="initialPoints" value="25000" readonly style="background: #f1f5f9;">
            </div>

            <div class="settings-group">
                <label class="settings-label">è¨ˆç®—åŸºæº–ç‚¹ï¼ˆ30,000ç‚¹ã¨ã—ã¦è¨ˆç®—ï¼‰</label>
                <input type="number" class="settings-input" id="calculationBase" value="30000" readonly style="background: #f1f5f9;">
            </div>

            <div class="settings-group">
                <label class="settings-label">ã‚¦ãƒï¼ˆ1ä½ / 4ä½ã¯è‡ªå‹•ã§åå¯¾ã®å€¤ï¼‰</label>
                <input type="number" class="settings-input" id="uma1" value="25" oninput="updateUmaDisplay()">
            </div>

            <div class="settings-group">
                <label class="settings-label">ã‚¦ãƒï¼ˆ2ä½ / 3ä½ã¯è‡ªå‹•ã§åå¯¾ã®å€¤ï¼‰</label>
                <input type="number" class="settings-input" id="uma2" value="10" oninput="updateUmaDisplay()">
            </div>

            <div class="settings-group">
                <label class="settings-label">ãƒˆãƒ“ã‚¦ãƒ</label>
                <input type="number" class="settings-input" id="tobiuma" value="10">
                <div style="font-size: 0.85em; color: #64748b; margin-top: 8px;">
                    â€» ãƒã‚¤ãƒŠã‚¹ç‚¹ãŒå‡ºãŸå ´åˆã€ãƒˆãƒã—ãŸäººã«åŠ ç®—ã•ã‚Œã¾ã™
                </div>
            </div>

            <div class="settings-group">
                <label class="settings-label">ãƒãƒƒãƒ—å˜ä¾¡</label>
                <input type="number" class="settings-input" id="chipPrice" value="5">
                <div style="font-size: 0.85em; color: #64748b; margin-top: 8px;">
                    â€» ãƒãƒƒãƒ—1æšã‚ãŸã‚Šã®ãƒã‚¤ãƒ³ãƒˆ
                </div>
            </div>

            <button class="btn btn-primary" onclick="startGame()">
                <span>ğŸ®</span>
                <span>ã‚²ãƒ¼ãƒ é–‹å§‹</span>
            </button>
        </div>

        <!-- Game Section -->
        <div id="gameContent" class="content">
            <div class="round-info">
                <div class="round-number" id="roundNumber">ç¬¬1å›æˆ¦</div>
            </div>

            <div class="validation-error" id="validationError"></div>

            <div class="score-inputs" id="scoreInputs">
                <!-- Dynamic score inputs will be inserted here -->
            </div>

            <div id="tobiSelection" style="display: none; margin-bottom: 20px;">
                <div style="background: #fef3c7; padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b; margin-bottom: 15px;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 10px;">âš ï¸ ãƒã‚¤ãƒŠã‚¹ç‚¹ãŒå‡ºã¾ã—ãŸ</div>
                    <div style="font-size: 0.9em; color: #78350f;">ãƒˆãƒã—ãŸäººã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒˆãƒ“ã‚¦ãƒ: <span id="tobiumaDisplay"></span>ç‚¹ï¼‰</div>
                </div>
                <div class="settings-group">
                    <label class="settings-label">ãƒˆãƒã—ãŸäºº</label>
                    <select id="tobiPlayerSelect" class="settings-input" style="cursor: pointer;">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-success" onclick="saveRound()">
                <span>âœ“</span>
                <span>ã‚¹ã‚³ã‚¢ç¢ºå®š</span>
            </button>

            <button class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none; margin-top: 10px;">
                ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="switchTab('scoreboard')">ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</button>
                <button class="btn btn-danger" onclick="showChipInput()">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
            </div>
        </div>

        <!-- Chip Input Section -->
        <div id="chipContent" class="content">
            <div class="section-title">ğŸ° ãƒãƒƒãƒ—å…¥åŠ›</div>
            
            <div style="background: #dbeafe; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 0.95em; color: #1e40af;">
                    å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒƒãƒ—æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
                    <span style="font-size: 0.85em; color: #64748b;">ãƒãƒƒãƒ—å˜ä¾¡: <span id="chipPriceDisplay"></span>ç‚¹ / åˆè¨ˆãŒ0ã«ãªã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</span>
                </div>
            </div>

            <div class="validation-error" id="chipValidationError"></div>

            <div class="player-inputs" id="chipInputs">
                <!-- Dynamic chip inputs will be inserted here -->
            </div>

            <button class="btn btn-success" onclick="applyChipsAndFinish()" style="margin-top: 20px;">
                <span>âœ“</span>
                <span>ãƒãƒƒãƒ—ã‚’åæ˜ ã—ã¦çµ‚äº†</span>
            </button>

            <button class="btn btn-secondary" onclick="skipChipsAndFinish()" style="margin-top: 10px;">
                ãƒãƒƒãƒ—ãªã—ã§çµ‚äº†
            </button>
        </div>

        <!-- Scoreboard Section -->
        <div id="scoreboardContent" class="content">
            <div class="scoreboard">
                <div class="scoreboard-header">ç¾åœ¨ã®ã‚¹ã‚³ã‚¢</div>
                <table class="scoreboard-table">
                    <thead>
                        <tr>
                            <th>é †ä½</th>
                            <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                            <th style="text-align: right;">ãƒã‚¤ãƒ³ãƒˆ</th>
                        </tr>
                    </thead>
                    <tbody id="scoreboardBody">
                        <!-- Dynamic scoreboard rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <button class="btn btn-primary" onclick="switchTab('game')" style="margin-top: 20px;">
                æ¬¡ã®å›æˆ¦ã¸
            </button>
        </div>

        <!-- History Section -->
        <div id="historyContent" class="content">
            <div class="section-title">å¯¾æˆ¦å±¥æ­´</div>
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <div class="empty-state-text">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================================
        // ğŸ”¥ Firebaseè¨­å®š - ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ï¼
        // ============================================================
        // 
        // ã€æ‰‹é †ã€‘
        // 1. Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« (https://console.firebase.google.com) ã‚’é–‹ã
        // 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ ãƒã‚¤ã‚¢ãƒ—ãƒª â†’ ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’ã‚³ãƒ”ãƒ¼
        // 3. ä¸‹ã®ã€ŒYOUR_API_KEYã€ãªã©ã®éƒ¨åˆ†ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã‚‹
        // 
        // ã€ä¾‹ã€‘
        // apiKey: "AIzaSyABC123def456GHI789jkl012MNO345pqr",
        // authDomain: "mahjong-12345.firebaseapp.com",
        // ãªã©
        //
        // ============================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBGR8A7KclzE3Jy65hU-uPfl0SqTTRe0VY",
            authDomain: "mahjong-calculator-bd572.firebaseapp.com",
            databaseURL: "https://mahjong-calculator-bd572-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mahjong-calculator-bd572",
            storageBucket: "mahjong-calculator-bd572.firebasestorage.app",
            messagingSenderId: "848965949758",
            appId: "1:848965949758:web:3f5a5c1279d2a03d9c346f"
        };
        
        // ============================================================
        // ã“ã“ã¾ã§ç·¨é›†
        // ============================================================

        // Initialize Firebase
        let firebaseApp = null;
        let database = null;
        let currentRoomRef = null;
        let currentRoomCode = null;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('Firebase initialized successfully');
            } else {
                console.warn('Firebase not configured. Using local mode only.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Game State
        let gameState = {
            players: [],
            rounds: [],
            currentRound: 0,
            settings: {
                initialPoints: 25000,      // Actual starting points
                calculationBase: 30000,    // Base for calculation
                uma1: 25,
                uma2: 10,
                uma3: -10,
                uma4: -25,
                tobiuma: 10,
                chipPrice: 5
            },
            gameStarted: false
        };

        // Room Management Functions
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Excluding similar looking characters
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function createRoom() {
            if (!database) {
                alert('Firebase ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™ã€‚');
                switchTab('setup');
                return;
            }

            const roomCode = generateRoomCode();
            const roomRef = database.ref('rooms/' + roomCode);

            // Check if room already exists
            roomRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Room code already exists, try again
                    createRoom();
                } else {
                    // Create new room
                    const userName = prompt('ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1') || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
                    
                    roomRef.set({
                        host: userName,
                        created: Date.now(),
                        participants: {
                            [userName]: { joined: Date.now(), index: 0 }
                        },
                        gameState: null
                    }).then(() => {
                        joinRoomByCode(roomCode, userName);
                    });
                }
            });
        }

        function joinRoom() {
            if (!database) {
                alert('Firebase ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™ã€‚');
                switchTab('setup');
                return;
            }

            const roomCode = document.getElementById('roomCodeInput').value.toUpperCase().trim();
            
            if (roomCode.length !== 4) {
                alert('4æ¡ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const userName = prompt('ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼') || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
            joinRoomByCode(roomCode, userName);
        }

        function joinRoomByCode(roomCode, userName) {
            const roomRef = database.ref('rooms/' + roomCode);

            roomRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const roomData = snapshot.val();
                const participants = roomData.participants || {};
                const participantCount = Object.keys(participants).length;

                if (participantCount >= 4) {
                    alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å“¡ã§ã™ï¼ˆ4/4ï¼‰');
                    return;
                }

                // Add user to participants
                roomRef.child('participants/' + userName).set({
                    joined: Date.now(),
                    index: participantCount
                }).then(() => {
                    currentRoomCode = roomCode;
                    currentRoomRef = roomRef;
                    
                    // Listen to room updates
                    setupRoomListeners();
                    
                    // Show room info
                    document.getElementById('roomSelection').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('currentRoomCode').textContent = roomCode;
                    
                    showToast(`ãƒ«ãƒ¼ãƒ  ${roomCode} ã«å‚åŠ ã—ã¾ã—ãŸ`);
                });
            });
        }

        function setupRoomListeners() {
            if (!currentRoomRef) return;

            // Listen to participants
            currentRoomRef.child('participants').on('value', (snapshot) => {
                const participants = snapshot.val() || {};
                const participantNames = Object.keys(participants);
                
                document.getElementById('participantCount').textContent = participantNames.length;
                
                const listHTML = participantNames.map((name, index) => 
                    `<div style="padding: 8px; background: white; border-radius: 6px; margin-bottom: 5px;">
                        ${index + 1}. ${name}
                    </div>`
                ).join('');
                
                document.getElementById('participantList').innerHTML = listHTML;
            });

            // Listen to game state updates
            currentRoomRef.child('gameState').on('value', (snapshot) => {
                const roomGameState = snapshot.val();
                if (roomGameState && roomGameState !== gameState) {
                    // Update local game state from room
                    Object.assign(gameState, roomGameState);
                    updateUI();
                    updateScoreboard();
                    updateHistory();
                }
            });
        }

        function leaveRoom() {
            if (!currentRoomRef || !confirm('ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) return;

            // Remove listeners
            currentRoomRef.off();
            
            currentRoomRef = null;
            currentRoomCode = null;
            
            document.getElementById('roomSelection').style.display = 'block';
            document.getElementById('roomInfo').style.display = 'none';
            document.getElementById('roomCodeInput').value = '';
            
            showToast('ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸ');
        }

        function startGameFromRoom() {
            currentRoomRef.child('participants').once('value').then((snapshot) => {
                const participants = snapshot.val() || {};
                const participantNames = Object.keys(participants);
                
                if (participantNames.length < 2) {
                    alert('æœ€ä½2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã§ã™');
                    return;
                }

                // Auto-fill player names from participants
                participantNames.forEach((name, index) => {
                    if (index < 4) {
                        document.getElementById(`player${index + 1}`).value = name;
                    }
                });

                // Fill remaining slots if less than 4
                for (let i = participantNames.length; i < 4; i++) {
                    document.getElementById(`player${i + 1}`).value = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`;
                }

                switchTab('setup');
                showToast('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’ç¢ºèªã—ã¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
            });
        }

        // Sync game state to Firebase
        function syncGameState() {
            if (currentRoomRef && gameState.gameStarted) {
                currentRoomRef.child('gameState').set(gameState);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGameState();
            updateUI();
        });

        // Update Uma (no display needed, just for consistency)
        function updateUmaDisplay() {
            // Function kept for oninput handlers, but no display updates needed
        }

        // Tab Switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Content').classList.add('active');

            // Update scoreboard when switching to it
            if (tabName === 'scoreboard') {
                updateScoreboard();
            }

            // Update history when switching to it
            if (tabName === 'history') {
                updateHistory();
            }
        }

        // Start Game
        function startGame() {
            const player1 = document.getElementById('player1').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            const player2 = document.getElementById('player2').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            const player3 = document.getElementById('player3').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3';
            const player4 = document.getElementById('player4').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4';

            gameState.players = [
                { name: player1, totalPoints: 0, rounds: [] },
                { name: player2, totalPoints: 0, rounds: [] },
                { name: player3, totalPoints: 0, rounds: [] },
                { name: player4, totalPoints: 0, rounds: [] }
            ];

            gameState.settings.initialPoints = 25000;
            gameState.settings.calculationBase = 30000;
            gameState.settings.uma1 = parseInt(document.getElementById('uma1').value) || 25;
            gameState.settings.uma2 = parseInt(document.getElementById('uma2').value) || 10;
            gameState.settings.uma3 = -gameState.settings.uma2;  // 3rd place is negative of 2nd
            gameState.settings.uma4 = -gameState.settings.uma1;  // 4th place is negative of 1st
            gameState.settings.tobiuma = parseInt(document.getElementById('tobiuma').value) || 10;
            gameState.settings.chipPrice = parseInt(document.getElementById('chipPrice').value) || 5;
            
            gameState.currentRound = 1;
            gameState.gameStarted = true;
            gameState.rounds = [];

            saveGameState();
            setupScoreInputs();
            
            // Enable game tab
            document.getElementById('gameTab').style.pointerEvents = 'auto';
            document.getElementById('gameTab').style.opacity = '1';
            
            // Switch to game tab
            switchTab('game');
            showToast('ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼');
        }

        // Setup Score Inputs
        function setupScoreInputs() {
            const container = document.getElementById('scoreInputs');
            container.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const row = document.createElement('div');
                row.className = 'score-input-row';
                row.innerHTML = `
                    <div class="player-name-display">${player.name}</div>
                    <div style="display: flex; gap: 8px; flex: 1;">
                        <button onclick="toggleMinus(${index})" 
                                class="minus-btn" 
                                id="minusBtn${index}"
                                type="button"
                                style="padding: 15px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer; min-width: 60px; transition: background 0.3s;">
                            Â±
                        </button>
                        <input type="tel" 
                               class="score-input" 
                               id="score${index}" 
                               placeholder="ç‚¹æ•°"
                               onchange="checkForNegativeScores()"
                               oninput="syncScoreInput(${index})"
                               style="flex: 1;">
                    </div>
                `;
                container.appendChild(row);
            });

            document.getElementById('roundNumber').textContent = `ç¬¬${gameState.currentRound}å›æˆ¦`;
            document.getElementById('tobiSelection').style.display = 'none';
            
            // Listen for score input updates from other players
            if (currentRoomRef) {
                currentRoomRef.child('currentInputs').on('value', (snapshot) => {
                    const inputs = snapshot.val();
                    if (inputs) {
                        Object.keys(inputs).forEach(playerIndex => {
                            const input = document.getElementById(`score${playerIndex}`);
                            if (input && document.activeElement !== input) {
                                // Only update if this input is not currently focused
                                input.value = inputs[playerIndex] || '';
                            }
                        });
                        checkForNegativeScores();
                    }
                });
            }
        }

        // Toggle minus sign
        function toggleMinus(playerIndex) {
            const input = document.getElementById(`score${playerIndex}`);
            const btn = document.getElementById(`minusBtn${playerIndex}`);
            let value = input.value.trim();
            
            if (value === '' || value === '0') {
                // Do nothing if empty or zero
                return;
            }
            
            if (value.startsWith('-')) {
                // Remove minus
                input.value = value.substring(1);
                btn.style.background = '#ef4444';
            } else {
                // Add minus
                input.value = '-' + value;
                btn.style.background = '#059669';
            }
            
            syncScoreInput(playerIndex);
            checkForNegativeScores();
        }

        // Sync score input to Firebase
        function syncScoreInput(playerIndex) {
            const input = document.getElementById(`score${playerIndex}`);
            const value = input.value;
            
            if (currentRoomRef) {
                currentRoomRef.child(`currentInputs/${playerIndex}`).set(value || null);
            }
        }

        // Clear current inputs when saving round
        function clearCurrentInputs() {
            if (currentRoomRef) {
                currentRoomRef.child('currentInputs').remove();
            }
        }

        // Check for negative scores
        function checkForNegativeScores() {
            const scores = [];
            let hasNegative = false;
            
            for (let i = 0; i < 4; i++) {
                const scoreInput = document.getElementById(`score${i}`);
                const score = parseInt(scoreInput.value);
                
                if (!isNaN(score)) {
                    scores.push(score);
                    if (score < 0) {
                        hasNegative = true;
                    }
                }
            }

            const tobiSelection = document.getElementById('tobiSelection');
            
            if (hasNegative && scores.length === 4) {
                // Show tobi selection
                tobiSelection.style.display = 'block';
                document.getElementById('tobiumaDisplay').textContent = gameState.settings.tobiuma;
                
                // Populate player select (exclude players with negative scores)
                const select = document.getElementById('tobiPlayerSelect');
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                gameState.players.forEach((player, index) => {
                    const score = parseInt(document.getElementById(`score${index}`).value);
                    if (score >= 0) {  // Only include players without negative scores
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = player.name;
                        select.appendChild(option);
                    }
                });
            } else {
                tobiSelection.style.display = 'none';
            }
        }

        // Validate Scores
        function validateScores(scores) {
            const total = scores.reduce((sum, score) => sum + score, 0);
            const initialTotal = 100000;  // 25000 x 4 players

            if (total !== initialTotal) {
                return {
                    valid: false,
                    message: `åˆè¨ˆç‚¹æ•°ãŒ${initialTotal.toLocaleString()}ç‚¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ï¼ˆç¾åœ¨: ${total.toLocaleString()}ç‚¹ï¼‰`
                };
            }

            return { valid: true };
        }

        // Calculate Final Scores with Uma
        function calculateFinalScores(rawScores, tobiPlayerIndex = null) {
            const { uma1, uma2, uma3, uma4, calculationBase, tobiuma } = gameState.settings;
            
            console.log('=== Calculate Final Scores ===');
            console.log('Raw scores:', rawScores);
            console.log('Tobi player index:', tobiPlayerIndex);
            
            // Create array with player index and raw score
            const playersWithScores = rawScores.map((score, index) => ({
                index,
                rawScore: score,
                adjustedScore: score
            }));

            // Sort by raw score (descending)
            playersWithScores.sort((a, b) => b.rawScore - a.rawScore);

            console.log('Sorted:');
            playersWithScores.forEach((p, i) => console.log(`  ${i+1}ä½: Player ${p.index}, ${p.rawScore}ç‚¹`));

            // Calculate adjusted scores for 2nd, 3rd, and 4th place
            playersWithScores[1].adjustedScore = (playersWithScores[1].rawScore - calculationBase) / 1000 + uma2;
            playersWithScores[2].adjustedScore = (playersWithScores[2].rawScore - calculationBase) / 1000 + uma3;
            playersWithScores[3].adjustedScore = (playersWithScores[3].rawScore - calculationBase) / 1000 + uma4;

            console.log('Before rounding:');
            console.log(`  2ä½: ${playersWithScores[1].adjustedScore}`);
            console.log(`  3ä½: ${playersWithScores[2].adjustedScore}`);
            console.log(`  4ä½: ${playersWithScores[3].adjustedScore}`);

            // Add tobiuma if there's a tobi (before rounding)
            if (tobiPlayerIndex !== null) {
                // Find the tobi player in sorted array
                const tobiPlayerInSorted = playersWithScores.find(p => p.index === tobiPlayerIndex);
                if (tobiPlayerInSorted && tobiPlayerInSorted !== playersWithScores[0]) {
                    tobiPlayerInSorted.adjustedScore += tobiuma;
                    console.log(`Added ${tobiuma} to tobi player (Player ${tobiPlayerIndex})`);
                }
                
                // Subtract tobiuma from players with negative raw scores
                playersWithScores.forEach((player, idx) => {
                    if (player.rawScore < 0 && idx !== 0) {
                        player.adjustedScore -= tobiuma;
                        console.log(`Subtracted ${tobiuma} from Player ${player.index} (negative score)`);
                    }
                });
            }

            // CRITICAL: Round 2nd, 3rd, 4th place scores first
            playersWithScores[1].adjustedScore = Math.round(playersWithScores[1].adjustedScore);
            playersWithScores[2].adjustedScore = Math.round(playersWithScores[2].adjustedScore);
            playersWithScores[3].adjustedScore = Math.round(playersWithScores[3].adjustedScore);

            console.log('After rounding:');
            console.log(`  2ä½: ${playersWithScores[1].adjustedScore}`);
            console.log(`  3ä½: ${playersWithScores[2].adjustedScore}`);
            console.log(`  4ä½: ${playersWithScores[3].adjustedScore}`);

            // Then calculate 1st place to ensure total is exactly 0
            const othersSum = playersWithScores[1].adjustedScore + playersWithScores[2].adjustedScore + playersWithScores[3].adjustedScore;
            playersWithScores[0].adjustedScore = -othersSum;

            console.log(`  1ä½: ${playersWithScores[0].adjustedScore} (= -(${othersSum}))`);

            // Handle tobi for 1st place (if they're the tobi player)
            if (tobiPlayerIndex !== null && playersWithScores[0].index === tobiPlayerIndex) {
                playersWithScores[0].adjustedScore += tobiuma;
                console.log(`Added ${tobiuma} to 1st place (tobi player)`);
                // Adjust to maintain zero sum
                const adjustment = tobiuma / 3;
                playersWithScores[1].adjustedScore -= Math.round(adjustment);
                playersWithScores[2].adjustedScore -= Math.round(adjustment);
                playersWithScores[3].adjustedScore -= Math.round(adjustment - (tobiuma - Math.round(adjustment) * 3));
            }

            // Create result array in original order
            const result = new Array(4);
            playersWithScores.forEach(player => {
                result[player.index] = {
                    rawScore: player.rawScore,
                    finalScore: player.adjustedScore,
                    rank: playersWithScores.findIndex(p => p.index === player.index) + 1
                };
                
                // Add tobi markers
                if (tobiPlayerIndex === player.index) {
                    result[player.index].tobiuma = tobiuma;
                }
                if (player.rawScore < 0 && tobiPlayerIndex !== null) {
                    result[player.index].tobiPenalty = -tobiuma;
                }
            });

            const checkSum = result[0].finalScore + result[1].finalScore + result[2].finalScore + result[3].finalScore;
            console.log('Final scores (original order):');
            result.forEach((r, i) => console.log(`  Player ${i}: ${r.finalScore}`));
            console.log(`Total: ${checkSum}`);
            console.log('===========================\n');

            return result;
        }

        // Edit Round
        let editingRoundIndex = null;

        function editRound(roundIndex) {
            console.log('editRound called with index:', roundIndex);
            console.log('Round data:', gameState.rounds[roundIndex]);
            
            if (!confirm(`ç¬¬${gameState.rounds[roundIndex].roundNumber}å›æˆ¦ã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            editingRoundIndex = roundIndex;
            const round = gameState.rounds[roundIndex];

            // Switch to game tab
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[1].classList.add('active');
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById('gameContent').classList.add('active');

            // Update round number display
            document.getElementById('roundNumber').textContent = `ç¬¬${round.roundNumber}å›æˆ¦ï¼ˆç·¨é›†ä¸­ï¼‰`;

            // Fill in the scores
            gameState.players.forEach((player, index) => {
                const input = document.getElementById(`score${index}`);
                if (input) {
                    input.value = round.scores[index].rawScore;
                    console.log(`Set score${index} to ${round.scores[index].rawScore}`);
                }
            });

            // Check for negative scores and set tobi player if applicable
            setTimeout(() => {
                checkForNegativeScores();
                if (round.tobiPlayer) {
                    const tobiPlayerIndex = gameState.players.findIndex(p => p.name === round.tobiPlayer);
                    if (tobiPlayerIndex !== -1) {
                        document.getElementById('tobiPlayerSelect').value = tobiPlayerIndex;
                    }
                }
            }, 100);

            // Change button text and show cancel button
            const saveButton = document.querySelector('#gameContent .btn-success');
            saveButton.innerHTML = '<span>âœ“</span><span>ç·¨é›†ã‚’ä¿å­˜</span>';
            document.getElementById('cancelEditBtn').style.display = 'block';

            showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
        }

        function cancelEdit() {
            if (!confirm('ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            editingRoundIndex = null;

            // Clear inputs
            for (let i = 0; i < 4; i++) {
                document.getElementById(`score${i}`).value = '';
            }
            document.getElementById('tobiSelection').style.display = 'none';
            
            // Clear Firebase current inputs
            clearCurrentInputs();

            // Reset button text and hide cancel button
            const saveButton = document.querySelector('#gameContent .btn-success');
            saveButton.innerHTML = '<span>âœ“</span><span>ã‚¹ã‚³ã‚¢ç¢ºå®š</span>';
            document.getElementById('cancelEditBtn').style.display = 'none';

            // Reset round number
            document.getElementById('roundNumber').textContent = `ç¬¬${gameState.currentRound}å›æˆ¦`;

            showToast('ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        }

        // Save Round
        function saveRound() {
            const scores = [];
            let hasNegative = false;
            
            for (let i = 0; i < 4; i++) {
                const scoreInput = document.getElementById(`score${i}`);
                const scoreText = scoreInput.value.trim();
                const score = parseInt(scoreText);
                
                if (isNaN(score) || scoreText === '') {
                    showValidationError('ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                scores.push(score);
                
                if (score < 0) {
                    hasNegative = true;
                }
            }

            // Validate scores total (must be 100,000)
            const validation = validateScores(scores);
            if (!validation.valid) {
                showValidationError(validation.message);
                return;
            }

            // Check if tobi player is selected when there's negative score
            let tobiPlayerIndex = null;
            if (hasNegative) {
                const tobiSelect = document.getElementById('tobiPlayerSelect');
                tobiPlayerIndex = tobiSelect.value;
                
                if (!tobiPlayerIndex) {
                    showValidationError('ãƒˆãƒã—ãŸäººã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                tobiPlayerIndex = parseInt(tobiPlayerIndex);
            }

            // Calculate final scores
            const finalScores = calculateFinalScores(scores, tobiPlayerIndex);

            if (editingRoundIndex !== null) {
                // Editing existing round
                const oldRound = gameState.rounds[editingRoundIndex];
                
                // Subtract old scores from player totals
                gameState.players.forEach((player, index) => {
                    player.totalPoints -= oldRound.scores[index].finalScore;
                });

                // Update round data
                oldRound.scores = finalScores;
                oldRound.tobiPlayer = tobiPlayerIndex !== null ? gameState.players[tobiPlayerIndex].name : null;

                // Add new scores to player totals
                gameState.players.forEach((player, index) => {
                    player.totalPoints += finalScores[index].finalScore;
                    player.rounds[editingRoundIndex] = finalScores[index];
                });

                showToast('ç·¨é›†ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                editingRoundIndex = null;
            } else {
                // Adding new round
                const roundData = {
                    roundNumber: gameState.currentRound,
                    scores: finalScores,
                    tobiPlayer: tobiPlayerIndex !== null ? gameState.players[tobiPlayerIndex].name : null
                };
                gameState.rounds.push(roundData);

                // Update player totals
                gameState.players.forEach((player, index) => {
                    player.rounds.push(finalScores[index]);
                    player.totalPoints += finalScores[index].finalScore;
                });

                // Increment round
                gameState.currentRound++;

                showToast('ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            }

            // Clear inputs
            for (let i = 0; i < 4; i++) {
                document.getElementById(`score${i}`).value = '';
            }
            document.getElementById('tobiSelection').style.display = 'none';
            
            // Clear Firebase current inputs
            clearCurrentInputs();

            // Reset button text
            const saveButton = document.querySelector('#gameContent .btn-success');
            saveButton.innerHTML = '<span>âœ“</span><span>ã‚¹ã‚³ã‚¢ç¢ºå®š</span>';
            document.getElementById('cancelEditBtn').style.display = 'none';

            // Reset round number display if was editing
            if (editingRoundIndex === null) {
                document.getElementById('roundNumber').textContent = `ç¬¬${gameState.currentRound}å›æˆ¦`;
            } else {
                document.getElementById('roundNumber').textContent = `ç¬¬${gameState.currentRound}å›æˆ¦`;
            }

            saveGameState();
            hideValidationError();
            updateScoreboard();
            
            switchTab('scoreboard');
        }

        // Update Scoreboard
        function updateScoreboard() {
            const tbody = document.getElementById('scoreboardBody');
            tbody.innerHTML = '';

            if (gameState.rounds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #94a3b8;">ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // Sort players by total points
            const sortedPlayers = [...gameState.players].sort((a, b) => b.totalPoints - a.totalPoints);

            sortedPlayers.forEach((player, index) => {
                const rank = index + 1;
                const roundedScore = Math.round(player.totalPoints);
                
                // Show chip info if available
                let chipInfo = '';
                if (player.chips !== undefined && player.chipPoints !== undefined) {
                    chipInfo = `<div style="font-size: 0.85em; color: #64748b;">ãƒãƒƒãƒ—: ${player.chips}æš (${player.chipPoints >= 0 ? '+' : ''}${Math.round(player.chipPoints)})</div>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="rank rank-${rank}">${rank}</div>
                    </td>
                    <td class="player-name-cell">
                        ${player.name}
                        ${chipInfo}
                    </td>
                    <td class="score-cell" style="text-align: right;">
                        <span class="${player.totalPoints >= 0 ? 'score-positive' : 'score-negative'}">
                            ${player.totalPoints >= 0 ? '+' : ''}${roundedScore}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('=== Scoreboard Debug ===');
            console.log('Total rounds:', gameState.rounds.length);
            gameState.players.forEach((player, idx) => {
                console.log(`${player.name}: ${Math.round(player.totalPoints)} (raw: ${player.totalPoints})`);
            });
        }

        // Update History
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (gameState.rounds.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div class="empty-state-text">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = '';

            gameState.rounds.forEach((round, roundIndex) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                let scoresHTML = '';
                gameState.players.forEach((player, index) => {
                    const score = round.scores[index];
                    const scoreClass = score.finalScore >= 0 ? 'score-positive' : 'score-negative';
                    
                    let badges = '';
                    if (score.tobiuma) {
                        badges += ` <span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">ãƒˆãƒ“+${score.tobiuma}</span>`;
                    }
                    if (score.tobiPenalty) {
                        badges += ` <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">ãƒˆãƒ“${score.tobiPenalty}</span>`;
                    }
                    
                    scoresHTML += `
                        <div class="history-score-item">
                            ${player.name}: <span class="${scoreClass}">${score.finalScore >= 0 ? '+' : ''}${Math.round(score.finalScore)}</span>${badges}
                            <small style="color: #94a3b8; margin-left: 5px;">(${score.rawScore.toLocaleString()}ç‚¹)</small>
                        </div>
                    `;
                });

                const tobiInfo = round.tobiPlayer ? `<div style="font-size: 0.85em; color: #f59e0b; margin-top: 8px;">ğŸ”¥ ãƒˆãƒã—ãŸäºº: ${round.tobiPlayer}</div>` : '';

                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div class="history-round">ç¬¬${round.roundNumber}å›æˆ¦</div>
                        <button onclick="editRound(${roundIndex})" class="edit-round-btn" data-round-index="${roundIndex}" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 6px;
                            font-size: 0.85em;
                            cursor: pointer;
                            transition: all 0.3s;
                            font-weight: 600;
                        ">âœï¸ ç·¨é›†</button>
                    </div>
                    <div class="history-scores">${scoresHTML}</div>
                    ${tobiInfo}
                `;
                
                historyList.appendChild(item);
            });

            // Add click event listeners to edit buttons
            document.querySelectorAll('.edit-round-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const roundIndex = parseInt(this.dataset.roundIndex);
                    editRound(roundIndex);
                });
                
                btn.addEventListener('mouseover', function() {
                    this.style.background = '#2563eb';
                    this.style.transform = 'scale(1.05)';
                });
                
                btn.addEventListener('mouseout', function() {
                    this.style.background = '#3b82f6';
                    this.style.transform = 'scale(1)';
                });
            });
        }

        // Show Chip Input
        function showChipInput() {
            if (gameState.rounds.length === 0) {
                if (confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                    endGame();
                }
                return;
            }

            // Setup chip inputs
            const container = document.getElementById('chipInputs');
            container.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const chipCount = player.chips || 0;
                const row = document.createElement('div');
                row.className = 'player-input-group';
                row.innerHTML = `
                    <div class="player-number">${index + 1}</div>
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${player.name}</div>
                        <input type="number" 
                               class="input-field" 
                               id="chip${index}" 
                               placeholder="ãƒãƒƒãƒ—æ•°"
                               value="${chipCount}"
                               inputmode="numeric"
                               style="margin: 0;">
                    </div>
                `;
                container.appendChild(row);
            });

            // Display chip price
            document.getElementById('chipPriceDisplay').textContent = gameState.settings.chipPrice;

            // Hide validation error
            document.getElementById('chipValidationError').classList.remove('show');

            // Switch to chip tab
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById('chipContent').classList.add('active');

            showToast('ãƒãƒƒãƒ—æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }

        // Apply Chips and Finish
        function applyChipsAndFinish() {
            const chipPrice = gameState.settings.chipPrice;
            
            // Get chip counts
            const chips = [];
            for (let i = 0; i < 4; i++) {
                const chipInput = document.getElementById(`chip${i}`);
                const chipCount = parseInt(chipInput.value) || 0;
                chips.push(chipCount);
            }

            // Check if total chips is 0
            const totalChips = chips.reduce((sum, c) => sum + c, 0);
            
            if (totalChips !== 0) {
                showValidationError(`ãƒãƒƒãƒ—ã®åˆè¨ˆãŒ0ã«ãªã£ã¦ã„ã¾ã›ã‚“ï¼ˆç¾åœ¨: ${totalChips > 0 ? '+' : ''}${totalChips}ï¼‰`);
                return;
            }

            // Apply chip points to player totals
            gameState.players.forEach((player, index) => {
                const chipPoints = chips[index] * chipPrice;
                player.totalPoints += chipPoints;
                player.chips = chips[index];
                player.chipPoints = chipPoints;
            });

            console.log('=== Chip Calculation ===');
            console.log('Total chips:', totalChips);
            gameState.players.forEach((player, index) => {
                console.log(`${player.name}: ${chips[index]} chips, ${player.chipPoints} points`);
            });

            saveGameState();
            updateScoreboard();
            hideValidationError();
            
            // Show final results
            switchTab('scoreboard');
            showToast('ãƒãƒƒãƒ—ã‚’åæ˜ ã—ã¾ã—ãŸï¼');
            
            // Show end game dialog after a short delay
            setTimeout(() => {
                if (confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã‹ã‚‰çµ‚äº†ã—ã¦ãã ã•ã„ã€‚')) {
                    endGame();
                }
            }, 1000);
        }

        // Skip Chips and Finish
        function skipChipsAndFinish() {
            if (confirm('ãƒãƒƒãƒ—ãªã—ã§ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                endGame();
            }
        }

        // End Game
        function endGame() {
            if (!confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) return;

            gameState = {
                players: [],
                rounds: [],
                currentRound: 0,
                settings: {
                    initialPoints: 25000,
                    calculationBase: 30000,
                    uma1: 25,
                    uma2: 10,
                    uma3: -10,
                    uma4: -25,
                    tobiuma: 10,
                    chipPrice: 5
                },
                gameStarted: false
            };

            saveGameState();
            switchTab('setup');
            showToast('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸ');
        }

        // Validation Error Display
        function showValidationError(message) {
            const errorDiv = document.getElementById('validationError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
            }
            
            // Also handle chip validation error
            const chipErrorDiv = document.getElementById('chipValidationError');
            if (chipErrorDiv) {
                chipErrorDiv.textContent = message;
                chipErrorDiv.classList.add('show');
            }
        }

        function hideValidationError() {
            const errorDiv = document.getElementById('validationError');
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }
            
            const chipErrorDiv = document.getElementById('chipValidationError');
            if (chipErrorDiv) {
                chipErrorDiv.classList.remove('show');
            }
        }

        // Toast Notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Local Storage
        function saveGameState() {
            localStorage.setItem('mahjongGameState', JSON.stringify(gameState));
            syncGameState(); // Sync to Firebase when saving locally
        }

        function loadGameState() {
            const saved = localStorage.getItem('mahjongGameState');
            if (saved) {
                gameState = JSON.parse(saved);
            }
        }

        function updateUI() {
            if (gameState.gameStarted) {
                setupScoreInputs();
                updateScoreboard();
                updateHistory();
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
